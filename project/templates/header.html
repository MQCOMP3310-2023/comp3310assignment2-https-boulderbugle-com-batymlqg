<div class="row top-menu">
  {% if show_search_bar %}
    <div class="col-md-6">
      <form action="{{ url_for('main.search_restaurant') }}" method="GET">
        <div class="input-group">
          <input type="text" id="search-input" name="q" class="form-control" placeholder="Search for a restaurant">
          <span class="input-group-btn">
            <button class="btn btn-primary" type="submit">Search</button>
          </span>
        </div>
      </form>
    </div>
  {% endif %}
  <button onclick="startRecording()">Start Recording</button>
  <button onclick="stopRecording()">Stop Recording</button>

  <script>
    var recognition;
    var audioChunks = [];

    function startRecording() {
        recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition || window.mozSpeechRecognition || window.msSpeechRecognition)();
        if ('SpeechRecognition' in window || 'webkitSpeechRecognition' in window || 'mozSpeechRecognition' in window || 'msSpeechRecognition' in window) {
            console.log('Speech recognition is supported in this browser');
        } else {
            console.log('Speech recognition is not supported in this browser');
        }

        recognition.interimResults = true;
        recognition.continuous = true;
  
        recognition.onresult = function(event) {
            var interimTranscript = '';
            for (var i = event.resultIndex; i < event.results.length; i++) {
                var transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    console.log('Final:', transcript);
                } else {
                interimTranscript += transcript;
                }
            }
            console.log('Interim:', interimTranscript);
        };

  
        recognition.onstart = function() {
            console.log('Recording started');
        };
  
        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
        };


        console.log('Recognition object:', recognition);

        try {
            recognition.start();
        } catch(error) {
            console.error("Error", error)
        }
    }   


    function stopRecording() {
      console.log('stopRecording() called');
      recognition.stop();
      console.log('Recording stopped');

      // Send the recorded audio to the server-side Python script
      sendAudioToServer();
    }

    function sendAudioToServer() {
      console.log('sendAudioToServer() called');
      var blob = new Blob(audioChunks, { type: 'audio/wav' });

      var xhr = new XMLHttpRequest();
      xhr.onload = function(e) {
        console.log('Server response received');
        if (this.readyState === 4) {
          console.log("Server returned:", e.target.responseText);
        }
      };

      var formData = new FormData();
      var timestamp = new Date().getTime(); // Get current timestamp
      var filename = 'recording_' + timestamp + '.wav'; // Generate filename with timestamp

      formData.append('audio', blob, filename);

      xhr.open('POST', '/save_audio', true);
      xhr.send(formData);
    }

    // Capture audio data from the microphone
    function handleAudioData(event) {
      console.log('handleAudioData() called');
      audioChunks.push(event.data);
    }

    // Attach the audio capture event to the media stream
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(function(stream) {
        console.log('getUserMedia() succeeded');
        var mediaRecorder = new MediaRecorder(stream);
        mediaRecorder.addEventListener('dataavailable', handleAudioData);
      })
      .catch(function(error) {
        console.error('Error accessing microphone:', error);
      });
  </script>

  <div class="col-md-6 text-right">
    {% if not current_user.is_authenticated %}
    <a href="/signup">Sign Up</a>
    <a href="/login">Login</a>
    {% endif %}
    {% if current_user.is_authenticated %}
    <a href="/profile">Your Profile</a>
    <a href="/logout"> Logout</a>
    {% endif %}

  </div>
</div>
